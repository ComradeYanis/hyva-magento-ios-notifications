<?php
declare(strict_types=1);

use Magento\Framework\Escaper;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\StoreConfig;
use Hyva\Theme\ViewModel\SvgIcons; // HyvÃ¤'s VM

/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var StoreConfig $storeConfig */
$storeConfig = $viewModels->require(StoreConfig::class);
$defaultSuccessMessageTimeout = (int) $storeConfig->getStoreConfig('hyva_theme_general/messages/success_message_timeout');

/** @var SvgIcons $svgIcons */
$svgIcons = $viewModels->require(SvgIcons::class);
?>

<!-- Pre-render SVGs from the BASE Luma module -->
<script>
    window.hyvaSvgIcons = {
        success: <?= json_encode($svgIcons->renderSvg('ComradeYanis_IOSToasts::images/icons/check.svg',   ['class'=>'w-5 h-5 stroke-emerald-500'])) ?>,
        error:   <?= json_encode($svgIcons->renderSvg('ComradeYanis_IOSToasts::images/icons/error.svg',   ['class'=>'w-5 h-5 stroke-rose-500'])) ?>,
        warning: <?= json_encode($svgIcons->renderSvg('ComradeYanis_IOSToasts::images/icons/warning.svg', ['class'=>'w-5 h-5 stroke-amber-500'])) ?>,
        notice:  <?= json_encode($svgIcons->renderSvg('ComradeYanis_IOSToasts::images/icons/info.svg',    ['class'=>'w-5 h-5 stroke-amber-500'])) ?>,
        close:   <?= json_encode($svgIcons->renderSvg('ComradeYanis_IOSToasts::images/icons/close.svg',   ['class'=>'w-3.5 h-3.5 stroke-black/70'])) ?>,
    };
</script>

<section id="hyva-ios-toasts"
         class="fixed z-[11000] pointer-events-none flex flex-col items-end justify-start right-4 left-auto bottom-4 sm:p-4 p-3
                pt-[calc(env(safe-area-inset-top,0px)+12px)]
                pb-[calc(env(safe-area-inset-bottom,0px)+16px)]"
         x-data="window.hyvaIosToasts()"
         x-bind="eventListeners"
         x-init="init()"
         aria-live="assertive" role="alert">

    <template x-for="toast in toasts" :key="toast.id">
        <div x-show="toast.visible"
             x-transition:enter="ios-toast-in"
             x-transition:leave="ios-toast-out"
             @click="close(toast.id)"
             class="pointer-events-auto glass mb-3 w-full max-w-sm px-4 pr-4 pl-10 py-3
                rounded-2xl border shadow-[0_8px_30px_rgba(0,0,0,0.18)]
                backdrop-blur-2xl [backdrop-filter:saturate(180%)]
                bg-white/20 border-white/35"
             :class="toneClass(toast.type)"
             role="status">

            <!-- Close -->
            <button type="button"
                    class="absolute left-2 top-2 grid place-items-center size-6 rounded-full
                     bg-white/20 border border-white/35 backdrop-blur-md
                     transition transform hover:scale-105 active:scale-95"
                    @click.stop="close(toast.id)" aria-label="Close">
                <span x-html="window.hyvaSvgIcons.close"></span>
            </button>

            <div class="flex items-start gap-3">
                <div class="mt-0.5 shrink-0" x-html="icon(toast.type)" aria-hidden="true"></div>
                <div class="min-w-0 flex-1">
                    <p class="text-sm font-semibold text-black/90" x-text="title(toast.type)"></p>
                    <p class="mt-0.5 text-sm text-black/85" x-html="toast.text"></p>
                </div>
            </div>
        </div>
    </template>
</section>

<style>
    .glass{position:relative;overflow:hidden}
    .glass::after,.glass::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none}
    .glass::after{background:linear-gradient(180deg,rgba(255,255,255,.55),rgba(255,255,255,0) 55%);opacity:.28}
    .glass::before{inset:-1px;background:
        radial-gradient(40% 60% at 98% 10%, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 60%),
        radial-gradient(35% 55% at 2% 90%,  rgba(255,255,255,.45) 0%, rgba(255,255,255,0) 65%),
        conic-gradient(from 200deg at 50% 50%, rgba(255,255,255,.18), rgba(255,255,255,0) 25% 75%, rgba(255,255,255,.18));
        mix-blend-mode:screen;opacity:.25;filter:blur(.6px)}
    .ios-toast-in{animation:iosToastIn .42s cubic-bezier(.22,1,.36,1)}
    .ios-toast-out{animation:iosToastOut .38s cubic-bezier(.22,1,.36,1) forwards}
    @keyframes iosToastIn{0%{opacity:0;transform:translateY(10px) scale(.96);filter:blur(2px)}60%{opacity:1;transform:translateY(0) scale(1.02);filter:blur(.5px)}100%{opacity:1;transform:translateY(0) scale(1)}}
    @keyframes iosToastOut{0%{opacity:1;transform:translateY(0) scale(1);filter:blur(0)}100%{opacity:0;transform:translateY(-6px) scale(.96);filter:blur(2px)}}
</style>

<script>
    "use strict";
    window.hyvaIosToasts = function () {
        return {
            messages: window.mageMessages || [],
            toasts: [], nextId: 1,

            init() {
                this.messages.forEach(m => this.push(m));
                const self = this;
                window.hyvaToasts = {
                    push:    p => self.push(p),
                    success: t => self.push({ type:'success', text:t }),
                    error:   t => self.push({ type:'error',   text:t }),
                    warning: t => self.push({ type:'warning', text:t }),
                    notice:  t => self.push({ type:'notice',  text:t }),
                };
                this.placeUnderHeader();
                requestAnimationFrame(() => this.placeUnderHeader());
                window.addEventListener('load', () => this.placeUnderHeader(), { once:true });

                let ticking=false;
                const req=()=>{ if(ticking) return; ticking=true; requestAnimationFrame(()=>{ this.placeUnderHeader(); ticking=false; }); };
                window.addEventListener('resize', req, {passive:true});
                window.addEventListener('scroll',  req, {passive:true});

                window.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ const last=this.toasts[this.toasts.length-1]; if(last) this.close(last.id);} });
            },

            eventListeners: {
                ['@messages-loaded.window'](e){ this.addMessages(e.detail.messages, e.detail.hideAfter); },
                ['@private-content-loaded.window'](e){
                    const d = e.detail?.data;
                    if (d?.messages?.messages?.length) this.addMessages(d.messages.messages);
                },
                ['@clear-messages.window'](){ this.toasts = []; },
            },

            addMessages(msgs, hideAfter){ (msgs||[]).forEach(m=> this.push({ type:m.type, text:m.text, timeout: hideAfter })); },

            placeUnderHeader(){
                const el = document.getElementById('hyva-ios-toasts'); if(!el) return;
                const header = document.querySelector('header.page-header') || document.querySelector('header');
                const pad = 12; const vh = Math.max(320, innerHeight || document.documentElement.clientHeight);
                let top = pad; if(header){ const hb = header.getBoundingClientRect().bottom; top = Math.max(pad, Math.min(vh-80, hb+pad)); }
                el.style.top = `${top}px`;
            },

            push({ type='notice', text='', timeout }){
                const id = this.nextId++; this.toasts.push({ id, type, text, visible:true });
                requestAnimationFrame(()=> this.placeUnderHeader());
                const auto = timeout ?? (type==='success' && window.defaultSuccessMessageTimeout ? window.defaultSuccessMessageTimeout : 4200);
                if (auto > 0) setTimeout(()=> this.close(id), auto);
            },

            close(id){ const t=this.toasts.find(x=>x.id===id); if(t) t.visible=false; setTimeout(()=> this.toasts = this.toasts.filter(x=>x.id!==id), 420); },

            title(type){ return type==='success'?'Success': type==='error'?'Error': type==='warning'?'Warning':'Notice'; },
            icon(type){
                if (type==='success') return window.hyvaSvgIcons.success;
                if (type==='error')   return window.hyvaSvgIcons.error;
                if (type==='warning' || type==='notice') return window.hyvaSvgIcons.warning;
                return window.hyvaSvgIcons.notice;
            },

            toneClass(type){
                if (type==='success') return 'border-emerald-400/40 shadow-[0_4px_18px_rgba(34,197,94,0.25)]';
                if (type==='error')   return 'border-rose-400/40 shadow-[0_4px_18px_rgba(244,63,94,0.22)]';
                return 'border-amber-400/40 shadow-[0_4px_18px_rgba(250,204,21,0.22)]';
            },
        }
    };
</script>
